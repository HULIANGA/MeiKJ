<style lang="sass">
  @import '../assets/css/style.scss'
</style>
<template>
  <div id="app">
    <header-menu :localcity="localCity"></header-menu>
    <swiper-image :datahref="dataHref"></swiper-image>
    <fashion-hair :hairitems="hairItems"></fashion-hair>
    <bottom-menu :active="'main'"></bottom-menu>
    <city-select :localcity="localCity"></city-select>
    <loading :show="loading.show"></loading>
  </div>
</template>

<script>
import HeaderMenu from '../components/HeaderMenu'
import SwiperImage from '../components/SwiperImage'
import FashionHair from '../components/FashionHair'
import BottomMenu from '../components/BottomMenu'
import CitySelect from '../components/CitySelect'
import Loading from '../components/Loading'
import cityJson from '../libs/area.js'
import provinceCity from '../libs/province_city.js'

export default {
  data () {
    return {
      loading: {
        show: true
      },
      dataHref: window.window.ctx + '/api/banner/list',
      hairItems: null,
      localCity: '定位中'
    }
  },
  created: function () {
    let self = this
    // 百度地图api放在最后加载，判断api加载完成后获取城市
    let getCityInterval = setInterval(() => {
      if (typeof (window.BMap) !== 'undefined') {
        this.loading.show = false
        this.getCity()
        clearInterval(getCityInterval)
      }
    }, 500)
    // 获取发型列表
    self.$http.get(window.ctx + '/api/hairstyle/list', {hairstyleClassId: 3}).then((response) => {
      let res = response.data
      if (res.code === 0) {
        self.$set('hairItems', res.result.result)
      }
    }, (response) => {
      self.loading.show = false
    })
  },
  components: {
    HeaderMenu,
    SwiperImage,
    FashionHair,
    BottomMenu,
    CitySelect,
    Loading
  },
  methods: {
    getCity: function () {
      let BaiduMap = window.BMap
      new BaiduMap.LocalCity().get((result) => {
        let cityName = result.name
        let cityCode = 310000
        for (let i = 0; i < provinceCity.data.length; i++) { // 根据定位的城市名匹配citycode
          for (let j = 0; j < provinceCity.data[i].cities.length; j++) {
            if (provinceCity.data[i].cities[j].city === cityName) {
              cityCode = parseInt(provinceCity.data[i].cities[j].city_code, 10)
              for (let i = 0; i < cityJson.data.row.length; i++) { // 根据citycode匹配城市简称
                if (parseInt(cityJson.data.row[i].area_id, 10) === cityCode) {
                  this.localCity = cityJson.data.row[i].area_name
                  localStorage.cityName = cityJson.data.row[i].area_name
                  localStorage.cityCode = cityCode
                  return false
                }
              }
            }
          }
        }
      })
    }
  },
  events: {
    'select-city': function (area) {
      this.localCity = area.name
    }
  }
}
</script>
<style>
  #app {
    padding-bottom: 60px;
  }
</style>
